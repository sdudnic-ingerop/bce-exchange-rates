<header>
  <div class="container">
    <div class="header-content">
      <a class="logo" (click)="navigateTo('home')">
        <img src="/ecb_logo.svg" alt="BCE Logo">
        <h1>Taux de Change BCE - Ingérop</h1>
      </a>
      <nav>
        <button [class.active]="currentView === 'home'" (click)="navigateTo('home')">
          Accueil
        </button>
        <button [class.active]="currentView === 'docs'" (click)="navigateTo('docs')">
          Docs API
        </button>
      </nav>
    </div>
  </div>
</header>

<main class="container">
  <div class="dev-warning-banner" role="alert" aria-live="polite">
    <mat-icon class="dev-warning-icon">warning</mat-icon>
    <div class="dev-warning-text">
      <strong>Site de développement.</strong>
      <div>
        <p>Données BCE transformées pour tests internes (possibles retards/incomplétudes). Pour des données brutes, utilisez les liens BCE via les icônes "BCE" ou les endpoints SDW dans la section Docs. Les endpoints locaux sont réservés au développement.</p>
        <p>Disponibilité: publication BCE vers 16h00 CET les jours ouvrables (hors fermetures TARGET) après la concertation (~14h10 CET). Avant cette heure ou en cas de fermeture, il peut n'y avoir aucune donnée.</p>
        <p>Doc officielle: <a href="https://data.ecb.europa.eu/help/api/data" target="_blank" rel="noopener noreferrer">API BCE</a>.</p>
      </div>
    </div>
  </div>
  <!-- Home View -->
  <div *ngIf="currentView === 'home'">
    <!-- Current date banner -->
    <div class="date-banner" *ngIf="referenceDate">
      <div class="date-left">
        <span class="date-label">Date de référence&nbsp;:</span>
        <span class="date-value">{{ formatDateForDisplay(parseDate(referenceDate)) }}</span>
      </div>
      <div class="date-right">Toutes les devises cotées par rapport à l'EUR (devise de base)</div>
    </div>

    <!-- Controls Section -->
    <section class="controls-section">
      <div class="currency-control">
        <mat-form-field appearance="outline">
          <mat-label>Devises</mat-label>
          <mat-chip-grid #chipGrid>
            <mat-chip-row *ngFor="let currency of selectedCurrencies" 
                          (removed)="removeCurrency(currency)">
              <img class="chip-flag" [src]="getFlagUrl(getCurrencyFlag(currency))" [alt]="currency">
              {{ currency }}
              <button matChipRemove>
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip-row>
            <input
              #currencyInput
              placeholder="Chercher par code ou pays..."
              [matChipInputFor]="chipGrid"
              [(ngModel)]="currencyFilter"
              (keydown)="onCurrencyInput($event)"
              (paste)="onCurrencyPaste($event)"
              [matAutocomplete]="auto"
              (blur)="onCurrencyPanelClosed()"
            />
          </mat-chip-grid>
          <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selectCurrency($event.option.value)" (closed)="onCurrencyPanelClosed()">
            <mat-option *ngFor="let code of filteredCurrencies" [value]="code">
              <div class="currency-option">
                <img class="option-flag" [src]="getFlagUrl(getCurrencyFlag(code))" [alt]="code">
                <span><strong>{{ code }}</strong> — {{ currencyNames[code] }}</span>
              </div>
            </mat-option>
          </mat-autocomplete>
          <button 
            *ngIf="selectedCurrencies.length > 0" 
            matSuffix 
            mat-icon-button 
            (click)="clearAllCurrencies()" 
            title="Supprimer toutes les devises"
            [matTooltip]="'Supprimer toutes les devises'"
          >
            <mat-icon>clear</mat-icon>
          </button>
        </mat-form-field>
      </div>
      
      <div class="date-control">
        <mat-form-field appearance="outline">
          <mat-label>Date (optionnel)</mat-label>
          <input 
            matInput 
            [matDatepicker]="picker"
            [(ngModel)]="selectedDate" 
            (dateChange)="onDateChange()"
            [matDatepickerFilter]="disableUnavailableDates"
            [max]="maxDate"
            placeholder="Laisser vide pour le taux le plus récent"
          />
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <button 
            *ngIf="selectedDate" 
            matSuffix 
            mat-icon-button 
            (click)="selectedDate = null; onDateChange()" 
            title="Supprimer la date"
            [matTooltip]="'Supprimer la date'"
            class="date-clear-button"
          >
            <mat-icon>clear</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </section>

    <!-- Loading / Error Messages -->
    <div *ngIf="loading" class="loading-message">
      Chargement des données...
    </div>

    <div *ngIf="error" class="error-message">
      {{ error }}
    </div>

    <!-- Content Grid: Table + Chart -->
    <div *ngIf="!loading && exchangeRates.length > 0" class="content-grid">
      <!-- Left Column: Table and CSV -->
      <section class="table-section">
        <div class="section-header">
          <div class="section-title">Au {{ formatDateForDisplay(parseDate(exchangeRates[0]?.date || '')) }} ({{ currencyCount }} devise{{ currencyCount > 1 ? 's' : '' }})</div>
          <div class="header-controls">
            <div class="header-links">
              <div class="link-pair" *ngIf="ecbSourceUrl">
                <span class="link-label">BCE:</span>
                <a [href]="getCurrentEcbUrl()" (click)="handleLinkClick($event, getCurrentEcbUrl())" class="link-icon" title="Copier le lien vers la réponse brute de la BCE">
                  <mat-icon>link</mat-icon>
                </a>
              </div>
              
              <div class="link-pair">
                <span class="link-label">Local:</span>
                <a [href]="getApiRequestUrl()" (click)="handleLinkClick($event, getApiRequestUrl())" class="link-icon" title="Copier le lien">
                  <mat-icon>link</mat-icon>
                </a>
              </div>
            </div>
            <button 
              class="icon-button-csv" 
              (click)="exportCSV()" 
              [disabled]="exchangeRates.length === 0"
              title="Télécharger les taux en CSV"
              [matTooltip]="'Télécharger les taux en CSV'"
            >
              <mat-icon>download</mat-icon>
            </button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th class="table-header table-group-header" colspan="3">Devise</th>
              <th class="table-header table-group-header align-right" colspan="2">Taux</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let rate of paginatedRates">
              <td class="currency-flag-cell">
                <img [src]="getFlagUrl(rate.flag)" [alt]="rate.currency">
              </td>
              <td class="currency-code-cell">
                <span class="currency-code">{{ rate.currency }}</span>
              </td>
              <td class="currency-name-cell">
                <span class="currency-name">{{ currencyNames[rate.currency] || rate.currency }}</span>
              </td>
              <td class="rate-trend-cell">
                <mat-icon *ngIf="rate.trend === 'down'" class="trend-icon down">arrow_downward</mat-icon>
                <mat-icon *ngIf="rate.trend === 'up'" class="trend-icon up">arrow_upward</mat-icon>
                <mat-icon *ngIf="!rate.trend || rate.trend === 'equal'" class="trend-icon neutral">remove</mat-icon>
              </td>
              <td class="rate-value-cell align-right">
                <span class="rate-value">{{ rate.rate !== null && rate.rate !== undefined ? rate.rate.toFixed(4) : '-' }}</span>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination Controls -->
        <div class="pagination-controls" *ngIf="totalPages > 1">
          <button mat-icon-button (click)="prevPage()" [disabled]="currentPage === 0">
            <mat-icon>chevron_left</mat-icon>
          </button>
          <span>Page {{ currentPage + 1 }} / {{ totalPages }}</span>
          <button mat-icon-button (click)="nextPage()" [disabled]="currentPage >= totalPages - 1">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>

      </section>

      <!-- Right Column: Chart -->
      <section class="chart-section">
        <div class="chart-header">
          <div class="section-title">Historique ({{ chartStartDate }} → {{ chartEndDate }})</div>
          
          <div class="chart-actions">
            <select [(ngModel)]="selectedPeriod" (change)="onPeriodChange()" class="period-dropdown">
              <option value="Mois">Mois</option>
              <option value="Trimestre">Trimestre</option>
              <option value="Année">Année</option>
              <option value="Tout">Tout</option>
            </select>
            
            <div class="header-links">
              <div class="link-pair" *ngIf="getHistoryEcbUrl()">
                <span class="link-label">BCE:</span>
                <a [href]="getHistoryEcbUrl()" (click)="handleLinkClick($event, getHistoryEcbUrl())" class="link-icon" title="Copier le lien">
                  <mat-icon>link</mat-icon>
                </a>
              </div>
              
              <div class="link-pair">
                <span class="link-label">Local:</span>
                <a [href]="getHistoryApiUrl()" (click)="handleLinkClick($event, getHistoryApiUrl())" class="link-icon" title="Copier le lien">
                  <mat-icon>link</mat-icon>
                </a>
              </div>
            </div>
            
            <button 
              class="icon-button-csv" 
              (click)="exportHistoryCSV()" 
              [disabled]="historyData.length === 0"
              title="Télécharger l'historique en CSV"
              [matTooltip]="'Télécharger l\'historique en CSV'"
            >
              <mat-icon>download</mat-icon>
            </button>
          </div>
        </div>

        <div class="chart-container">
          <canvas #ratesChart id="ratesChart"></canvas>
        </div>

      </section>
    </div>


  </div>

  <!-- Docs View -->
  <div *ngIf="currentView === 'docs'" class="docs-container">
    <app-docs-section></app-docs-section>
  </div>
</main>

<footer class="site-footer">
  <div class="container footer-content">
    <span class="footer-left">{{ footerLabel }}</span>
    <span class="footer-right">v.{{ appVersion }}</span>
  </div>
</footer>

